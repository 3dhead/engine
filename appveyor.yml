version: 0.1-{build}

environment:
  INTELOCLSDKROOT: C:\Program Files (x86)\Intel\OpenCL SDK\5.3

image: Visual Studio 2017

configuration: Release

platform:
- x64

shallow_clone: true

cache:
  - C:\Tools\vcpkg\installed\

# vcpkg enet, imgui are already available, but no on appveyor yet
# qt5 don't build
#  lua glm glslang gtest curl libuv zlib
install:
  - cmd: set VCPKG_DEFAULT_TRIPLET=x64-windows
  - cmd: vcpkg integrate install
  - cmd: vcpkg install curl[winssl] libpq opencl sdl2 lua libuv
  # Install OpenCL Runtime
  - cmd: choco install opencl-intel-cpu-runtime
  #- cmd: appveyor DownloadFile "http://registrationcenter-download.intel.com/akdlm/irc_nas/12512/opencl_runtime_16.1.2_x64_setup.msi"
  #- cmd: start /wait msiexec /i opencl_runtime_16.1.2_x64_setup.msi /qn  /l*v opencl_runtime.log
  # Check if it's working
  - cmd: appveyor DownloadFile "https://ci.appveyor.com/api/projects/oblomov/clinfo/artifacts/clinfo.exe?job=platform:+x64" -FileName clinfo.exe
  - clinfo.exe

build_script:
  - md build
  - cd build
  - cmake .. -DDISABLE_UNITY=On
  - cmake --build .
  - dir

artifacts:
  - name: TestResults
    path: build/tests-*.xml

test_script:
  - ctest -V -C Debug -R tests-computeshadertool
  - CORE_LOGLEVEL=0 ctest -V -C Debug -R tests-core
  - ctest -V -C Debug -R tests-mail
  - ctest -V -C Debug -R tests-math
  - ctest -V -C Debug -R tests-util
  - ctest -V -C Debug -R tests-stock
  - ctest -V -C Debug -R tests-shadertool
  - ctest -V -C Debug -R tests-testtraze
  - ctest -V -C Debug -R tests-voxelworld

after_test:
  - ps: |
      $wc = New-Object 'System.Net.WebClient'
      foreach ($file in Get-ChildItem -Path "$($env:APPVEYOR_BUILD_FOLDER)\build\" -Filter tests-*.xml) {
        $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", $file.FullName)
      }
